<!DOCTYPE html>
<html>
<head>
    <title>AutoFill Debugger</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid #6c757d;
        }
        .error-entry {
            background-color: #fff3f3;
            border-left: 4px solid #dc3545;
        }
        .timestamp {
            color: #6c757d;
            font-size: 0.8em;
        }
        .category {
            font-weight: bold;
            margin-right: 10px;
        }
        .log-message {
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .stack-trace {
            font-family: monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            background-color: #f0f0f0;
            padding: 10px;
            margin-top: 5px;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        .expandable {
            cursor: pointer;
        }
        #debug-actions {
            position: sticky;
            top: 0;
            background-color: white;
            padding: 15px 0;
            z-index: 100;
            border-bottom: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AutoFill Debugger</h1>
        
        <div id="debug-actions" class="mb-4">
            <div class="row">
                <div class="col-md-6">
                    <h3>Debug Controls</h3>
                    <button id="refreshLogs" class="btn btn-primary mr-2">Refresh Logs</button>
                    <button id="clearLogs" class="btn btn-danger mr-2">Clear Logs</button>
                    <button id="testProfile" class="btn btn-info mr-2">Test Profile Data</button>
                    <button id="exportLogs" class="btn btn-secondary">Export Logs</button>
                </div>
                <div class="col-md-6">
                    <h3>Current Profile</h3>
                    <div id="currentProfile">Loading...</div>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs" id="debugTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="errors-tab" data-toggle="tab" href="#errors" role="tab">Errors</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="logs-tab" data-toggle="tab" href="#logs" role="tab">Logs</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab">Profile Data</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="system-tab" data-toggle="tab" href="#system" role="tab">System Info</a>
            </li>
        </ul>
        
        <div class="tab-content" id="debugTabsContent">
            <div class="tab-pane fade show active" id="errors" role="tabpanel">
                <div class="mt-3 mb-2">
                    <h3>Errors <span id="error-count" class="badge badge-danger">0</span></h3>
                </div>
                <div id="error-container">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="logs" role="tabpanel">
                <div class="mt-3 mb-2">
                    <h3>Logs <span id="log-count" class="badge badge-primary">0</span></h3>
                </div>
                <div id="log-container">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="profile" role="tabpanel">
                <div class="mt-3 mb-2">
                    <h3>Profile Data</h3>
                </div>
                <pre id="profile-data" class="bg-light p-3">Loading profile data...</pre>
            </div>
            
            <div class="tab-pane fade" id="system" role="tabpanel">
                <div class="mt-3 mb-2">
                    <h3>System Information</h3>
                </div>
                <div id="system-info">
                    <table class="table table-striped">
                        <tbody id="system-info-table">
                            <tr>
                                <td colspan="2" class="text-center">Loading system information...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
        // Debug utility functions
        const DebugUtil = {
            logs: [],
            errors: [],
            
            // Load logs from Chrome storage
            loadLogs: function() {
                chrome.storage.local.get(['autofill_debug_logs', 'autofill_debug_errors'], (result) => {
                    this.logs = result.autofill_debug_logs || [];
                    this.errors = result.autofill_debug_errors || [];
                    
                    // Update UI
                    this.updateLogsUI();
                    this.updateErrorsUI();
                    
                    // Update counts
                    document.getElementById('log-count').textContent = this.logs.length;
                    document.getElementById('error-count').textContent = this.errors.length;
                });
            },
            
            // Clear logs in Chrome storage
            clearLogs: function() {
                if (confirm('Are you sure you want to clear all logs?')) {
                    chrome.storage.local.remove(['autofill_debug_logs', 'autofill_debug_errors'], () => {
                        this.logs = [];
                        this.errors = [];
                        
                        // Update UI
                        this.updateLogsUI();
                        this.updateErrorsUI();
                        
                        // Update counts
                        document.getElementById('log-count').textContent = '0';
                        document.getElementById('error-count').textContent = '0';
                    });
                }
            },
            
            // Update logs UI
            updateLogsUI: function() {
                const container = document.getElementById('log-container');
                container.innerHTML = '';
                
                if (this.logs.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No logs available.</div>';
                    return;
                }
                
                // Sort logs by timestamp (newest first)
                const sortedLogs = [...this.logs].sort((a, b) => {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                // Create log entries
                sortedLogs.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    
                    const timestamp = document.createElement('div');
                    timestamp.className = 'timestamp';
                    timestamp.textContent = new Date(log.timestamp).toLocaleString();
                    
                    const category = document.createElement('span');
                    category.className = 'category';
                    category.textContent = log.category || 'unknown';
                    
                    const message = document.createElement('div');
                    message.className = 'log-message';
                    message.textContent = log.message || '';
                    
                    logEntry.appendChild(timestamp);
                    logEntry.appendChild(category);
                    logEntry.appendChild(message);
                    
                    container.appendChild(logEntry);
                });
            },
            
            // Update errors UI
            updateErrorsUI: function() {
                const container = document.getElementById('error-container');
                container.innerHTML = '';
                
                if (this.errors.length === 0) {
                    container.innerHTML = '<div class="alert alert-success">No errors recorded.</div>';
                    return;
                }
                
                // Sort errors by timestamp (newest first)
                const sortedErrors = [...this.errors].sort((a, b) => {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                // Create error entries
                sortedErrors.forEach(error => {
                    const errorEntry = document.createElement('div');
                    errorEntry.className = 'log-entry error-entry expandable';
                    
                    const timestamp = document.createElement('div');
                    timestamp.className = 'timestamp';
                    timestamp.textContent = new Date(error.timestamp).toLocaleString();
                    
                    const category = document.createElement('span');
                    category.className = 'category';
                    category.textContent = error.category || 'unknown';
                    
                    const message = document.createElement('div');
                    message.className = 'log-message';
                    message.textContent = error.message || '';
                    
                    const stack = document.createElement('div');
                    stack.className = 'stack-trace';
                    stack.textContent = error.stack || 'No stack trace available';
                    
                    errorEntry.appendChild(timestamp);
                    errorEntry.appendChild(category);
                    errorEntry.appendChild(message);
                    errorEntry.appendChild(stack);
                    
                    // Toggle stack trace visibility on click
                    errorEntry.addEventListener('click', function() {
                        const stackTrace = this.querySelector('.stack-trace');
                        if (stackTrace.style.display === 'block') {
                            stackTrace.style.display = 'none';
                        } else {
                            stackTrace.style.display = 'block';
                        }
                    });
                    
                    container.appendChild(errorEntry);
                });
            },
            
            // Load and display profile data
            loadProfileData: function() {
                chrome.storage.local.get(['lastSelectedProfile', 'profilesList'], (profileResult) => {
                    let currentProfile = 'default';
                    
                    if (profileResult.lastSelectedProfile && 
                        profileResult.profilesList && 
                        profileResult.profilesList.includes(profileResult.lastSelectedProfile)) {
                        currentProfile = profileResult.lastSelectedProfile;
                    }
                    
                    document.getElementById('currentProfile').innerHTML = `
                        <strong>Current Profile:</strong> ${currentProfile}<br>
                        <strong>Available Profiles:</strong> ${(profileResult.profilesList || ['default']).join(', ')}
                    `;
                    
                    // Now get data for the current profile
                    let userDataKey = "userdata_" + currentProfile;
                    
                    chrome.storage.local.get([userDataKey, "userdata"], (result) => {
                        let userData = result[userDataKey] || (currentProfile === "default" ? result.userdata : null);
                        
                        if (userData) {
                            // Format and display the data
                            try {
                                if (typeof userData === 'string') {
                                    userData = JSON.parse(userData);
                                }
                                document.getElementById('profile-data').textContent = JSON.stringify(userData, null, 2);
                            } catch (e) {
                                document.getElementById('profile-data').textContent = 'Error parsing profile data: ' + e.message;
                            }
                        } else {
                            document.getElementById('profile-data').textContent = 'No profile data found.';
                        }
                    });
                });
            },
            
            // Load system information
            loadSystemInfo: function() {
                const systemInfo = {
                    'Browser': navigator.userAgent,
                    'Platform': navigator.platform,
                    'Extension Version': chrome.runtime.getManifest().version,
                    'Timestamp': new Date().toLocaleString()
                };
                
                // Get the permissions
                chrome.permissions.getAll(permissions => {
                    systemInfo['Permissions'] = permissions.permissions.join(', ');
                    systemInfo['Host Permissions'] = permissions.origins.join(', ');
                    
                    // Get storage usage
                    chrome.storage.local.getBytesInUse(null, bytesInUse => {
                        systemInfo['Storage Usage'] = `${(bytesInUse / 1024).toFixed(2)} KB`;
                        
                        // Update the UI
                        const table = document.getElementById('system-info-table');
                        table.innerHTML = '';
                        
                        for (const [key, value] of Object.entries(systemInfo)) {
                            const row = document.createElement('tr');
                            
                            const keyCell = document.createElement('td');
                            keyCell.textContent = key;
                            keyCell.style.fontWeight = 'bold';
                            keyCell.style.width = '30%';
                            
                            const valueCell = document.createElement('td');
                            valueCell.textContent = value;
                            
                            row.appendChild(keyCell);
                            row.appendChild(valueCell);
                            
                            table.appendChild(row);
                        }
                    });
                });
            },
            
            // Test profile data 
            testProfileData: function() {
                chrome.storage.local.get(['lastSelectedProfile', 'profilesList'], (profileResult) => {
                    let currentProfile = 'default';
                    
                    if (profileResult.lastSelectedProfile && 
                        profileResult.profilesList && 
                        profileResult.profilesList.includes(profileResult.lastSelectedProfile)) {
                        currentProfile = profileResult.lastSelectedProfile;
                    }
                    
                    // Now get data for the current profile
                    let userDataKey = "userdata_" + currentProfile;
                    
                    chrome.storage.local.get([userDataKey, "userdata"], (result) => {
                        let userData = result[userDataKey] || (currentProfile === "default" ? result.userdata : null);
                        
                        const testResults = document.createElement('div');
                        testResults.className = 'alert alert-info mt-3';
                        
                        if (userData) {
                            try {
                                if (typeof userData === 'string') {
                                    userData = JSON.parse(userData);
                                    testResults.innerHTML += '<p>Profile data is stored as a string and needs parsing.</p>';
                                }
                                
                                // Check essential fields
                                const essentialFields = ['first name', 'last name', 'email', 'phone'];
                                const missingFields = [];
                                
                                essentialFields.forEach(field => {
                                    if (!userData[field]) {
                                        missingFields.push(field);
                                    }
                                });
                                
                                if (missingFields.length > 0) {
                                    testResults.innerHTML += `<p>Missing essential fields: ${missingFields.join(', ')}</p>`;
                                } else {
                                    testResults.innerHTML += '<p>All essential fields are present.</p>';
                                }
                                
                                // Check arrays
                                if (!Array.isArray(userData.educations)) {
                                    testResults.innerHTML += '<p>educations is not an array or is missing.</p>';
                                }
                                
                                if (!Array.isArray(userData.experiences)) {
                                    testResults.innerHTML += '<p>experiences is not an array or is missing.</p>';
                                }
                                
                                // Add a summary
                                testResults.innerHTML = `<h4>Profile Test Results for "${currentProfile}"</h4>` + testResults.innerHTML;
                                
                            } catch (e) {
                                testResults.className = 'alert alert-danger mt-3';
                                testResults.innerHTML = `<h4>Error Testing Profile "${currentProfile}"</h4><p>Error: ${e.message}</p>`;
                            }
                        } else {
                            testResults.className = 'alert alert-danger mt-3';
                            testResults.innerHTML = `<h4>No Profile Data Found for "${currentProfile}"</h4><p>Please create a profile.</p>`;
                        }
                        
                        // Add to the UI
                        const container = document.getElementById('profile');
                        
                        // Remove any previous test results
                        const previousResults = container.querySelectorAll('.alert');
                        previousResults.forEach(el => el.remove());
                        
                        container.appendChild(testResults);
                    });
                });
            },
            
            // Export logs to a file
            exportLogs: function() {
                const data = {
                    logs: this.logs,
                    errors: this.errors,
                    timestamp: new Date().toISOString(),
                    version: chrome.runtime.getManifest().version,
                    browser: navigator.userAgent
                };
                
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `autofill-logs-${new Date().toISOString().replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);
            }
        };
        
        // Initialize the debug page
        document.addEventListener('DOMContentLoaded', function() {
            // Load logs
            DebugUtil.loadLogs();
            
            // Load profile data
            DebugUtil.loadProfileData();
            
            // Load system info
            DebugUtil.loadSystemInfo();
            
            // Set up button handlers
            document.getElementById('refreshLogs').addEventListener('click', () => {
                DebugUtil.loadLogs();
                DebugUtil.loadProfileData();
                DebugUtil.loadSystemInfo();
            });
            
            document.getElementById('clearLogs').addEventListener('click', () => {
                DebugUtil.clearLogs();
            });
            
            document.getElementById('testProfile').addEventListener('click', () => {
                DebugUtil.testProfileData();
            });
            
            document.getElementById('exportLogs').addEventListener('click', () => {
                DebugUtil.exportLogs();
            });
        });
    </script>
</body>
</html> 